<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CGPA Calculator ‚Ä¢ Multi-Semester</title>
  <meta name="description" content="Kira GPA & CGPA (multi-semester), autosave, import/export JSON. Sesuai untuk GitHub Pages." />
  <style>
    :root{
      --bg:#0a0f1f;
      --card:#121a33;
      --text:#eef2ff;
      --muted:#a9b3d1;
      --line:#23305c;
      --accent:#7c5cff;
      --accent2:#2ee59d;
      --danger:#ff5c7a;
      --shadow: 0 16px 35px rgba(4,6,20,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      background:
        radial-gradient(1200px 600px at 12% 2%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(900px 500px at 88% 8%, rgba(46,229,157,.18), transparent 55%),
        radial-gradient(1000px 600px at 50% 100%, rgba(255,92,122,.16), transparent 60%),
        linear-gradient(180deg, rgba(9,12,24,.92), rgba(9,12,24,1));
      color:var(--text);
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(700px 320px at 80% 90%, rgba(124,92,255,.12), transparent 60%),
        radial-gradient(500px 200px at 10% 80%, rgba(46,229,157,.08), transparent 55%);
      pointer-events:none;
      z-index:-1;
    }
    a{color:inherit}
    .wrap{max-width:1140px;margin:0 auto;padding:28px 16px 70px;}
    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:20px;
    }
    h1{margin:0;font-size:clamp(22px,3vw,36px);letter-spacing:.3px}
    .sub{margin:8px 0 0;color:var(--muted);font-size:14px;line-height:1.5}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:999px;user-select:none;
      background: rgba(18,26,51,.35);
      display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:14px 0 16px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .hero{
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,.8fr);
      gap:16px;
      padding:20px 22px;
      align-items:center;
      background:
        radial-gradient(400px 200px at 90% 10%, rgba(124,92,255,.25), transparent 60%),
        rgba(18,26,51,.45);
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      margin-bottom:18px;
    }
    .hero h2{
      margin:0 0 8px;
      font-size:clamp(20px,2.4vw,28px);
    }
    .hero p{margin:0;color:var(--muted);line-height:1.6;font-size:14px;}
    .hero-cta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;}
    .hero-art{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      background: linear-gradient(145deg, rgba(124,92,255,.22), rgba(46,229,157,.12));
      border:1px solid rgba(255,255,255,.08);
      min-height:190px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hero-art svg{width:100%;height:100%;display:block;}
    .top{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button, .btn{
      border:0;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:650;
      letter-spacing:.2px;color:var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      display:inline-flex;align-items:center;gap:8px;
      text-decoration:none;
    }
    button:hover,.btn:hover{background: rgba(255,255,255,.12);border-color: rgba(255,255,255,.18);}
    button:active,.btn:active{transform: translateY(1px);}
    .primary{
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.72));
      border-color: rgba(124,92,255,.55);
    }
    .primary:hover{background: linear-gradient(180deg, rgba(124,92,255,1), rgba(124,92,255,.78));}
    .ok{
      background: rgba(46,229,157,.12);
      border-color: rgba(46,229,157,.35);
      color:#d9fff0;
    }
    .ok:hover{background: rgba(46,229,157,.18);border-color: rgba(46,229,157,.5);}
    .danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.35);
      color:#ffd7de;
    }
    .danger:hover{background: rgba(255,92,122,.18);border-color: rgba(255,92,122,.5);}

    .seg{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      padding:10px 14px 0;
    }
    .seg label{font-size:13px;color:var(--muted)}
    select, input{
      width:100%;
      padding:10px 10px;border-radius:10px;outline:none;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    input::placeholder{color: rgba(169,179,209,.65);}
    input:focus, select:focus{border-color: rgba(124,92,255,.65);box-shadow: 0 0 0 3px rgba(124,92,255,.18);}

    .content{padding:12px 14px 14px;}
    .semesterHead{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:10px 14px 0;
    }
    .semesterTitle{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .semesterTitle b{font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .w200{min-width:200px}
    .w260{min-width:260px}
    .tableWrap{padding:10px 0 0;}
    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,51,.55);
    }
    thead th{
      text-align:left;font-size:13px;color:var(--muted);font-weight:700;
      padding:12px 12px;background: rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    tbody td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top;}
    tbody tr:last-child td{border-bottom:0;}
    .cellStack{display:flex;flex-direction:column;gap:6px;}
    .err{display:none;color:#ffd0d9;font-size:12px;line-height:1.2;}
    .hasErr .err{display:block;}
    .hasErr input, .hasErr select{border-color: rgba(255,92,122,.65);box-shadow: 0 0 0 3px rgba(255,92,122,.16);}
    .rowBtn{padding:9px 10px;border-radius:10px;font-size:13px;white-space:nowrap;}
    .grid{
      margin-top:14px;
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;
    }
    .stat{
      background: rgba(18,26,51,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
    }
    .stat .k{color:var(--muted);font-size:12px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;}
    .stat .v{margin-top:6px;font-size:22px;font-weight:800;letter-spacing:.2px;}
    .hint{margin-top:12px;color:var(--muted);font-size:13px;line-height:1.55;}
    .footer{
      margin-top:10px;color: rgba(169,179,209,.75);font-size:12px;line-height:1.55;
      padding:0 2px;
    }
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:16px;
      background: rgba(18,26,51,.92);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:12px;
      color:var(--text);
      box-shadow: var(--shadow);
      display:none;
      max-width:min(720px,calc(100% - 28px));
      font-size:13px;
    }
    .toast.show{display:block;animation:pop .18s ease;}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px);opacity:.4}to{transform:translateX(-50%) translateY(0);opacity:1}}

    .mobileLabel{display:none;}
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr;}
    }
    @media (max-width: 950px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width: 900px){
      thead{display:none;}
      table,tbody,tr,td{display:block;width:100%;}
      tbody td{border-bottom:0;padding:10px 12px 6px;}
      tbody tr{border-bottom:1px solid rgba(255,255,255,.08);}
      tbody tr:last-child{border-bottom:0;}
      .mobileLabel{display:block;color:var(--muted);font-size:12px;font-weight:700;margin-bottom:6px;}
      .w200,.w260{min-width:unset;width:100%;}
      .semesterHead{gap:12px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>CGPA Calculator</h1>
      <p class="sub">
        Versi ditambah baik: <b>multi-semester</b>, kiraan live, autosave, import/export JSON.
      </p>
    </div>
    <div class="pill" id="statusPill">Autosave: ON ‚Ä¢ Live calc: ON</div>
  </header>

  <section class="hero">
    <div>
      <h2>Pantau prestasi akademik dengan paparan yang lebih kemas.</h2>
      <p>
        Kemas kini UI ini menambah tema latar yang lebih menarik, ilustrasi ringkas, serta fungsi
        <b>Download PDF</b> untuk simpan laporan CGPA dalam format profesional.
      </p>
      <div class="hero-cta">
        <button id="downloadPdfBtn" class="primary" type="button">‚¨áÔ∏è Download PDF</button>
        <button id="addSemBtn" class="ok" type="button">üìö Tambah Semester</button>
      </div>
    </div>
    <div class="hero-art" aria-hidden="true">
      <svg viewBox="0 0 520 320" role="img" focusable="false">
        <defs>
          <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#7c5cff" stop-opacity="0.9" />
            <stop offset="100%" stop-color="#2ee59d" stop-opacity="0.85" />
          </linearGradient>
        </defs>
        <rect width="520" height="320" rx="22" fill="url(#grad)" opacity="0.35" />
        <circle cx="110" cy="90" r="46" fill="#fff" opacity="0.25" />
        <circle cx="420" cy="70" r="32" fill="#fff" opacity="0.18" />
        <path d="M80 210h320a20 20 0 0 1 20 20v40a14 14 0 0 1-14 14H94a14 14 0 0 1-14-14v-44a16 16 0 0 1 16-16z" fill="#0b1020" opacity="0.9" />
        <rect x="110" y="140" width="300" height="18" rx="9" fill="#0b1020" opacity="0.7" />
        <rect x="110" y="170" width="250" height="14" rx="7" fill="#0b1020" opacity="0.55" />
        <rect x="110" y="235" width="180" height="18" rx="9" fill="#7c5cff" opacity="0.8" />
        <rect x="110" y="260" width="220" height="10" rx="5" fill="#2ee59d" opacity="0.7" />
        <text x="110" y="95" fill="#ffffff" font-size="16" font-family="Segoe UI, Arial" opacity="0.7">CGPA Report</text>
      </svg>
    </div>
  </section>

  <div class="row">
    <div class="pill">
      Skala: A=4.00 ‚Ä¢ A-=3.67 ‚Ä¢ B+=3.33 ‚Ä¢ B=3.00 ‚Ä¢ B-=2.67 ‚Ä¢ C+=2.33 ‚Ä¢ C=2.00 ‚Ä¢ C-=1.67 ‚Ä¢ D+=1.33 ‚Ä¢ D=1.00 ‚Ä¢ F=0.00
    </div>
    <div class="actions">
      <button id="exportBtn" type="button">‚¨áÔ∏è Export JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer">‚¨ÜÔ∏è Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="resetAllBtn" class="danger" type="button">‚ôªÔ∏è Reset Semua</button>
    </div>
  </div>

  <section class="card">
    <div class="top">
      <div class="pill">
        Tips: Edit nama semester, tambah subjek, masukkan kredit & pilih gred. Kiraan auto update.
      </div>
      <div class="actions">
        <button id="addCourseBtn" class="primary" type="button">‚ûï Tambah Subjek</button>
        <button id="dupSemBtn" type="button">üß∑ Duplicate Semester</button>
        <button id="clearSemBtn" class="danger" type="button">üßπ Kosongkan Semester</button>
      </div>
    </div>

    <div class="semesterHead">
      <div class="semesterTitle">
        <b>Semester Aktif</b>
        <span class="small">Pilih semester di kanan</span>
      </div>
      <div class="inline">
        <div class="w260">
          <label class="small" for="semSelect">Pilih Semester</label>
          <select id="semSelect"></select>
        </div>
        <div class="w260">
          <label class="small" for="semName">Nama Semester</label>
          <input id="semName" type="text" placeholder="Contoh: Semester 1 (2025/2026)" />
        </div>
      </div>
    </div>

    <div class="content">
      <div class="tableWrap">
        <table aria-label="Jadual subjek">
          <thead>
            <tr>
              <th style="width:46%">Nama Subjek (optional)</th>
              <th style="width:16%">Kredit</th>
              <th style="width:22%">Gred</th>
              <th style="width:16%">Tindakan</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="grid" aria-label="Keputusan">
        <div class="stat">
          <div class="k">GPA Semester</div>
          <div class="v" id="outSemGPA">0.00</div>
        </div>
        <div class="stat">
          <div class="k">Kredit Semester</div>
          <div class="v" id="outSemCredits">0.00</div>
        </div>
        <div class="stat">
          <div class="k">CGPA Keseluruhan</div>
          <div class="v" id="outCGPA">0.00</div>
        </div>
        <div class="stat">
          <div class="k">Jumlah Kredit</div>
          <div class="v" id="outAllCredits">0.00</div>
        </div>
      </div>

      <div class="hint">
        <b>Nota:</b> Formula: TotalPoints = Œ£(kredit√ógradePoint), GPA/CGPA = TotalPoints / TotalCredits.
        Jika ada input tak valid (kredit kosong/0 atau gred belum pilih), baris itu akan ditanda merah.
      </div>

      <div class="footer">
        <b>Deploy GitHub Pages:</b> pastikan fail bernama <code>index.html</code> di root repo.
        Settings ‚Üí Pages ‚Üí Branch: <code>main</code>, Folder: <code>/(root)</code>.
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
  // ===== Grade points (Malaysia standard) =====
  const GRADE_POINTS = {
    "A": 4.00, "A-": 3.67, "B+": 3.33, "B": 3.00, "B-": 2.67,
    "C+": 2.33, "C": 2.00, "C-": 1.67, "D+": 1.33, "D": 1.00, "F": 0.00
  };

  const STORAGE_KEY = "cgpa_multi_sem_v1";

  const els = {
    statusPill: document.getElementById("statusPill"),
    addSemBtn: document.getElementById("addSemBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importFile: document.getElementById("importFile"),
    resetAllBtn: document.getElementById("resetAllBtn"),
    addCourseBtn: document.getElementById("addCourseBtn"),
    dupSemBtn: document.getElementById("dupSemBtn"),
    clearSemBtn: document.getElementById("clearSemBtn"),
    semSelect: document.getElementById("semSelect"),
    semName: document.getElementById("semName"),
    tbody: document.getElementById("tbody"),
    outSemGPA: document.getElementById("outSemGPA"),
    outSemCredits: document.getElementById("outSemCredits"),
    outCGPA: document.getElementById("outCGPA"),
    outAllCredits: document.getElementById("outAllCredits"),
    toast: document.getElementById("toast"),
    downloadPdfBtn: document.getElementById("downloadPdfBtn")
  };

  // ===== App State =====
  let state = {
    activeSemId: "",
    semesters: [
      // { id, name, rows: [{course, credit, grade}] }
    ]
  };

  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function fmt2(n){
    if (!isFinite(n)) return "0.00";
    return Number(n).toFixed(2);
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>els.toast.classList.remove("show"), 2400);
  }

  function createGradeOptions(selected=""){
    const order = ["", "A","A-","B+","B","B-","C+","C","C-","D+","D","F"];
    return order.map(g=>{
      if(g==="") return `<option value="" ${selected===""?"selected":""} disabled>Pilih gred</option>`;
      return `<option value="${g}" ${selected===g?"selected":""}>${g} (${GRADE_POINTS[g].toFixed(2)})</option>`;
    }).join("");
  }

  function defaultRows(n=5){
    return Array.from({length:n}, ()=>({course:"", credit:"", grade:""}));
  }

  function getActiveSem(){
    return state.semesters.find(s=>s.id===state.activeSemId) || null;
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...state, ts: Date.now() }));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.semesters) || !parsed.semesters.length) return false;
      state = {
        activeSemId: parsed.activeSemId || parsed.semesters[0].id,
        semesters: parsed.semesters
      };
      // ensure active exists
      if(!state.semesters.some(s=>s.id===state.activeSemId)) state.activeSemId = state.semesters[0].id;
      return true;
    }catch(e){
      return false;
    }
  }

  function ensureAtLeastOneSemester(){
    if(state.semesters.length) return;
    const id = uid();
    state.semesters = [{ id, name:"Semester 1", rows: defaultRows(5) }];
    state.activeSemId = id;
  }

  // ===== Rendering =====
  function renderSemesterSelect(){
    const opts = state.semesters.map((s, i)=> {
      const label = s.name?.trim() ? s.name.trim() : `Semester ${i+1}`;
      return `<option value="${s.id}">${escapeHtml(label)}</option>`;
    }).join("");
    els.semSelect.innerHTML = opts;
    els.semSelect.value = state.activeSemId;

    const active = getActiveSem();
    els.semName.value = active?.name ?? "";
  }

  function rowTemplate(r={}, idx=0){
    const course = r.course ?? "";
    const credit = (r.credit ?? "") === "" ? "" : String(r.credit);
    const grade  = r.grade ?? "";
    return `
      <tr data-idx="${idx}">
        <td>
          <div class="cellStack" data-field="course">
            <span class="mobileLabel">Nama Subjek (optional)</span>
            <input type="text" placeholder="Contoh: Kesihatan Awam" value="${escapeHtml(course)}" />
            <div class="err">‚Äî</div>
          </div>
        </td>
        <td>
          <div class="cellStack" data-field="credit">
            <span class="mobileLabel">Kredit</span>
            <input type="number" inputmode="decimal" min="0" step="0.5" placeholder="Contoh: 3" value="${escapeHtml(credit)}" />
            <div class="err">Kredit mesti nombor &gt; 0.</div>
          </div>
        </td>
        <td>
          <div class="cellStack" data-field="grade">
            <span class="mobileLabel">Gred</span>
            <select>${createGradeOptions(grade)}</select>
            <div class="err">Sila pilih gred.</div>
          </div>
        </td>
        <td>
          <span class="mobileLabel">Tindakan</span>
          <button class="rowBtn danger" type="button" data-action="remove">üóëÔ∏è Padam</button>
        </td>
      </tr>
    `;
  }

  function renderTable(){
    const sem = getActiveSem();
    els.tbody.innerHTML = (sem?.rows || []).map((r,i)=>rowTemplate(r,i)).join("");
    wireRowListeners();
  }

  function setError(elStack, isErr){
    if(isErr) elStack.classList.add("hasErr");
    else elStack.classList.remove("hasErr");
  }

  function validateAndCompute(){
    const sem = getActiveSem();
    if(!sem) return;

    let semCredits=0, semPoints=0;

    // validate active semester rows (mark errors)
    [...els.tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
      const creditStack = tr.querySelector('[data-field="credit"]');
      const gradeStack  = tr.querySelector('[data-field="grade"]');
      const creditInput = creditStack.querySelector("input");
      const gradeSelect = gradeStack.querySelector("select");

      const c = creditInput.value==="" ? NaN : Number(creditInput.value);
      const gp = GRADE_POINTS[gradeSelect.value];

      const creditBad = !(isFinite(c) && c > 0);
      const gradeBad  = !gradeSelect.value;

      setError(creditStack, creditBad);
      setError(gradeStack, gradeBad);

      // compute only if valid
      if(!creditBad && !gradeBad){
        semCredits += c;
        semPoints  += c * gp;
      }

      // sync into state
      const tds = tr.querySelectorAll("td");
      sem.rows[idx] = {
        course: tds[0].querySelector("input").value.trim(),
        credit: creditInput.value==="" ? "" : Number(creditInput.value),
        grade: gradeSelect.value
      };
    });

    const semGPA = semCredits>0 ? semPoints/semCredits : 0;
    els.outSemCredits.textContent = fmt2(semCredits);
    els.outSemGPA.textContent = fmt2(semGPA);

    // compute overall CGPA across all semesters (valid rows only)
    let allCredits=0, allPoints=0;
    for(const s of state.semesters){
      for(const r of s.rows){
        const c = Number(r.credit);
        const gp = GRADE_POINTS[r.grade];
        if(!(isFinite(c) && c>0)) continue;
        if(gp===undefined) continue;
        allCredits += c;
        allPoints  += c * gp;
      }
    }
    const cgpa = allCredits>0 ? allPoints/allCredits : 0;
    els.outAllCredits.textContent = fmt2(allCredits);
    els.outCGPA.textContent = fmt2(cgpa);

    save();
  }

  function wireRowListeners(){
    [...els.tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
      tr.querySelectorAll("input, select").forEach(el=>{
        el.addEventListener("input", ()=> validateAndCompute());
        el.addEventListener("change", ()=> validateAndCompute());
      });
      tr.querySelector('button[data-action="remove"]').addEventListener("click", ()=>{
        const sem = getActiveSem();
        sem.rows.splice(idx, 1);
        if(sem.rows.length===0) sem.rows = defaultRows(1);
        renderTable();
        validateAndCompute();
      });
    });
  }

  // ===== Report PDF =====
  function buildReportHtml(){
    const now = new Date();
    const timestamp = now.toLocaleString();

    let allCredits = 0;
    let allPoints = 0;
    const semesterSummaries = state.semesters.map((sem, index)=>{
      let semCredits = 0;
      let semPoints = 0;
      const rowsHtml = sem.rows.map(r => {
        const c = Number(r.credit);
        const gp = GRADE_POINTS[r.grade];
        const validCredit = isFinite(c) && c > 0;
        const validGrade = gp !== undefined;
        const creditPoint = validCredit && validGrade ? (c * gp) : null;
        if (validCredit && validGrade) {
          semCredits += c;
          semPoints += c * gp;
        }
        const courseLabel = r.course?.trim() ? r.course.trim() : "-";
        return `
          <tr>
            <td>${escapeHtml(courseLabel)}</td>
            <td>${validCredit ? fmt2(c) : "-"}</td>
            <td>${validGrade ? escapeHtml(r.grade) : "-"}</td>
            <td>${validGrade ? gp.toFixed(2) : "-"}</td>
            <td>${creditPoint !== null ? fmt2(creditPoint) : "-"}</td>
          </tr>
        `;
      }).join("");

      allCredits += semCredits;
      allPoints += semPoints;

      const semGPA = semCredits > 0 ? semPoints / semCredits : 0;
      const semName = sem.name?.trim() ? sem.name.trim() : `Semester ${index + 1}`;
      return {
        name: semName,
        rowsHtml: rowsHtml || "<tr><td colspan=\"5\">Tiada data.</td></tr>",
        semCredits: fmt2(semCredits),
        semGPA: fmt2(semGPA)
      };
    });

    const cgpa = allCredits > 0 ? allPoints / allCredits : 0;
    const activeSem = getActiveSem();
    const activeSummary = activeSem
      ? semesterSummaries[state.semesters.findIndex(s => s.id === activeSem.id)]
      : null;

    const summaryHtml = `
      <section class="summary">
        <div>
          <h2>Ringkasan</h2>
          <p>Tarikh & masa (local): <b>${escapeHtml(timestamp)}</b></p>
        </div>
        <div class="summary-grid">
          <div class="summary-card">
            <span>GPA Semester Aktif</span>
            <strong>${activeSummary ? activeSummary.semGPA : fmt2(0)}</strong>
          </div>
          <div class="summary-card">
            <span>Kredit Semester Aktif</span>
            <strong>${activeSummary ? activeSummary.semCredits : fmt2(0)}</strong>
          </div>
          <div class="summary-card">
            <span>CGPA Keseluruhan</span>
            <strong>${fmt2(cgpa)}</strong>
          </div>
          <div class="summary-card">
            <span>Jumlah Kredit</span>
            <strong>${fmt2(allCredits)}</strong>
          </div>
        </div>
      </section>
    `;

    const semesterBlocks = semesterSummaries.map(summary => `
      <section class="semester-block">
        <div class="semester-head">
          <h3>${escapeHtml(summary.name)}</h3>
          <div class="semester-meta">
            <span>GPA: <b>${summary.semGPA}</b></span>
            <span>Kredit: <b>${summary.semCredits}</b></span>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Subjek</th>
              <th>Kredit</th>
              <th>Gred</th>
              <th>Grade Point</th>
              <th>Mata Kredit</th>
            </tr>
          </thead>
          <tbody>
            ${summary.rowsHtml}
          </tbody>
        </table>
      </section>
    `).join("");

    return `
      <!doctype html>
      <html lang="ms">
      <head>
        <meta charset="utf-8" />
        <title>CGPA Report</title>
        <style>
          :root{
            --text:#111827;
            --muted:#6b7280;
            --line:#e5e7eb;
          }
          *{box-sizing:border-box}
          body{
            margin:0;
            font-family: "Segoe UI", Arial, sans-serif;
            color:var(--text);
            background:#f8fafc;
          }
          .page{
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 32px 40px;
            background:#ffffff;
          }
          header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:16px;
            border-bottom:2px solid var(--line);
            padding-bottom:12px;
            margin-bottom:20px;
          }
          header h1{
            margin:0;
            font-size:26px;
          }
          header span{
            font-size:12px;
            color:var(--muted);
          }
          .summary h2{margin:0 0 8px;font-size:18px;}
          .summary p{margin:0;color:var(--muted);font-size:13px;}
          .summary-grid{
            display:grid;
            grid-template-columns:repeat(4,minmax(0,1fr));
            gap:12px;
            margin-top:12px;
          }
          .summary-card{
            border:1px solid var(--line);
            border-radius:10px;
            padding:10px 12px;
            background:#f8fafc;
          }
          .summary-card span{display:block;font-size:12px;color:var(--muted);}
          .summary-card strong{font-size:16px;}
          .semester-block{
            margin-top:20px;
            break-inside: avoid;
            page-break-inside: avoid;
          }
          .semester-head{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            margin-bottom:8px;
          }
          .semester-head h3{margin:0;font-size:16px;}
          .semester-meta{font-size:12px;color:var(--muted);display:flex;gap:12px;}
          table{
            width:100%;
            border-collapse:collapse;
            font-size:12px;
            border:1px solid var(--line);
          }
          thead th{
            background:#f1f5f9;
            text-align:left;
            padding:8px;
            border-bottom:1px solid var(--line);
          }
          tbody td{
            padding:8px;
            border-bottom:1px solid var(--line);
            vertical-align:top;
          }
          tbody tr:last-child td{border-bottom:0;}
          @media print{
            @page{size:A4;margin:12mm;}
            body{background:#ffffff;}
            .page{padding:0;max-width:100%;}
            header{page-break-after:avoid;}
            table{page-break-inside:auto;}
            tr{break-inside:avoid;page-break-inside:avoid;}
          }
        </style>
      </head>
      <body>
        <div class="page">
          <header>
            <div>
              <h1>CGPA Report</h1>
              <span>Generated from CGPA Calculator</span>
            </div>
            <span>${escapeHtml(timestamp)}</span>
          </header>
          ${summaryHtml}
          ${semesterBlocks}
        </div>
      </body>
      </html>
    `;
  }

  function downloadPdf(){
    const reportHtml = buildReportHtml();
    const win = window.open("", "_blank");
    if(!win){
      toast("Popup disekat. Benarkan pop-up untuk muat turun PDF.");
      return;
    }
    win.document.open();
    win.document.write(reportHtml);
    win.document.close();
    win.focus();
    setTimeout(()=>{
      win.print();
    }, 600);
  }

  // ===== Actions =====
  function addSemester(copyFromActive=false){
    const id = uid();
    const active = getActiveSem();
    const n = state.semesters.length + 1;
    const newSem = {
      id,
      name: `Semester ${n}`,
      rows: copyFromActive ? JSON.parse(JSON.stringify(active?.rows || defaultRows(5))) : defaultRows(5)
    };
    state.semesters.push(newSem);
    state.activeSemId = id;
    renderAll();
    toast(copyFromActive ? "Semester diduplikasi." : "Semester baru ditambah.");
  }

  function addCourseRow(){
    const sem = getActiveSem();
    sem.rows.push({course:"", credit:"", grade:""});
    renderTable();
    validateAndCompute();
  }

  function clearActiveSemester(){
    const sem = getActiveSem();
    sem.rows = defaultRows(5);
    renderTable();
    validateAndCompute();
    toast("Semester dikosongkan.");
  }

  function resetAll(){
    localStorage.removeItem(STORAGE_KEY);
    state = { activeSemId:"", semesters:[] };
    ensureAtLeastOneSemester();
    renderAll();
    toast("Semua data direset.");
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cgpa-data.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Fail JSON diexport.");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || !Array.isArray(parsed.semesters) || parsed.semesters.length===0){
          toast("JSON tidak sah.");
          return;
        }
        // normalize
        parsed.semesters.forEach((s,i)=>{
          if(!s.id) s.id = uid();
          if(!Array.isArray(s.rows)) s.rows = defaultRows(5);
          if(!s.name) s.name = `Semester ${i+1}`;
          s.rows = s.rows.map(r=>(
            {
              course: r?.course ?? "",
              credit: (r?.credit ?? "") === "" ? "" : Number(r.credit),
              grade: r?.grade ?? ""
            }
          ));
        });
        state.semesters = parsed.semesters;
        state.activeSemId = parsed.activeSemId && state.semesters.some(s=>s.id===parsed.activeSemId)
          ? parsed.activeSemId
          : state.semesters[0].id;

        renderAll();
        toast("JSON berjaya diimport.");
      }catch(e){
        toast("Gagal import: JSON tidak sah.");
      }
    };
    reader.readAsText(file);
  }

  function renderAll(){
    renderSemesterSelect();
    renderTable();
    validateAndCompute();
  }

  // ===== UI wiring =====
  els.semSelect.addEventListener("change", ()=>{
    state.activeSemId = els.semSelect.value;
    renderAll();
  });

  els.semName.addEventListener("input", ()=>{
    const sem = getActiveSem();
    sem.name = els.semName.value;
    renderSemesterSelect(); // keep dropdown label updated
    save();
  });

  els.addSemBtn.addEventListener("click", ()=> addSemester(false));
  els.dupSemBtn.addEventListener("click", ()=> addSemester(true));
  els.addCourseBtn.addEventListener("click", addCourseRow);
  els.clearSemBtn.addEventListener("click", clearActiveSemester);
  els.resetAllBtn.addEventListener("click", resetAll);
  els.exportBtn.addEventListener("click", exportJSON);
  els.downloadPdfBtn.addEventListener("click", downloadPdf);

  els.importFile.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value = "";
  });

  // ===== Init =====
  (function init(){
    const ok = load();
    if(!ok){
      ensureAtLeastOneSemester();
      save();
    }else{
      ensureAtLeastOneSemester();
    }
    renderAll();
  })();
</script>
</body>
</html>
